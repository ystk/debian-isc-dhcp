#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2010-3611.dpatch by  <apollock@debian.org>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Backport of fix in 4.1.2
## DP: Stolen from https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2010-3611

@DPATCH@
diff -urNad isc-dhcp~/server/dhcpv6.c isc-dhcp/server/dhcpv6.c
--- isc-dhcp~/server/dhcpv6.c	2010-06-06 23:02:45.000000000 -0700
+++ isc-dhcp/server/dhcpv6.c	2010-11-19 20:53:11.000000000 -0800
@@ -4196,10 +4196,25 @@
 	 * If there is no link address, we will use the interface
 	 * that this packet came in on to pick the shared_network.
 	 */
-	} else {
+	} else if (packet->interface != NULL) {
 		status = shared_network_reference(shared,
 					 packet->interface->shared_network,
 					 MDL);
+                if (packet->dhcpv6_container_packet != NULL) {
+			log_info("[L2 Relay] No link address in relay packet "
+				 "assuming L2 relay and using receiving "
+				 "interface");
+                }
+
+	} else {
+		/*
+		 * We shouldn't be able to get here but if there is no link
+		 * address and no interface we don't know where to get the
+		 * pool from log an error and return an error.
+		 */
+		log_error("No interface and no link address " 
+			  "can't determine pool");
+		status = ISC_R_INVALIDARG;
 	}
 
 	return status;
@@ -5487,6 +5502,7 @@
 
 	enc_packet->client_port = packet->client_port;
 	enc_packet->client_addr = packet->client_addr;
+	interface_reference(&enc_packet->interface, packet->interface, MDL);
 	enc_packet->dhcpv6_container_packet = packet;
 
 	msg_type = enc_opt_data.data[0];
